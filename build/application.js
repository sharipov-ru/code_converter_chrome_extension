// Generated by CoffeeScript 1.3.3
(function() {
  var Application, Clipboard, Converter, Notification, applcation,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Application = (function() {

    function Application() {
      this.setupContextMenus = __bind(this.setupContextMenus, this);
      this.setupContextMenus();
      this.converter = new Converter();
    }

    Application.prototype.setupContextMenus = function() {
      var hamlMenu, sassMenu, scssMenu,
        _this = this;
      hamlMenu = chrome.contextMenus.create({
        title: "Copy as Haml",
        contexts: ["selection"],
        onclick: function(info, tab) {
          return _this.converter.html2haml(info.selectionText);
        }
      });
      sassMenu = chrome.contextMenus.create({
        title: "Copy as SASS",
        contexts: ["selection"],
        onclick: function(info, tab) {
          return _this.converter.css2sass(info.selectionText, "SASS");
        }
      });
      scssMenu = chrome.contextMenus.create({
        title: "Copy as SCSS",
        contexts: ["selection"],
        onclick: function(info, tab) {
          return _this.converter.css2sass(info.selectionText, "SCSS");
        }
      });
      return sassMenu = chrome.contextMenus.create({
        title: "Copy as Coffescript",
        contexts: ["selection"],
        onclick: function(info, tab) {
          return _this.converter.js2coffee(info.selectionText);
        }
      });
    };

    return Application;

  })();

  Converter = (function() {

    function Converter() {
      this.js2coffee = __bind(this.js2coffee, this);

      this.css2sass = __bind(this.css2sass, this);

      this.html2haml = __bind(this.html2haml, this);

    }

    Converter.prototype.html2haml = function(selectedText) {
      var htmlSample, notification;
      htmlSample = "{page: {html: '" + selectedText + "'}}";
      notification = new Notification();
      notification.show("info", "Converting html to haml...", "Results will be copied to your system buffer");
      return $.ajax({
        url: "http://html2haml.heroku.com/api.json",
        type: "POST",
        data: htmlSample,
        dataType: "json",
        success: function(data) {
          var clipboard;
          clipboard = new Clipboard();
          clipboard.copy(data.page.haml);
          return notification.show("success", "Converted!", "Results copied to your system buffer");
        },
        error: function(data) {
          return alert('haml converting error');
        }
      });
    };

    Converter.prototype.css2sass = function(selectedText, sassType) {
      return $.ajax({
        url: "http://css2sass.heroku.com/json",
        type: "POST",
        data: {
          page: {
            css: selectedText
          },
          commit: "Convert 2" + " " + sassType
        },
        dataType: "json",
        success: function(data) {
          var clipboard, notification;
          clipboard = new Clipboard();
          clipboard.copy(data.page.sass);
          notification = new Notification();
          return notification.show("success", "Converting css to " + sassType + "...", "Results will be copied to your system buffer");
        },
        error: function(data) {
          return alert('saas converting error');
        }
      });
    };

    Converter.prototype.js2coffee = function(selectedText) {
      return $.ajax({
        url: "http://git.rordev.ru:8080/convert",
        type: "POST",
        data: {
          js: selectedText
        },
        dataType: "json",
        success: function(data) {
          var clipboard, notification;
          clipboard = new Clipboard();
          clipboard.copy(data.coffee);
          notification = new Notification();
          return notification.show("success", "Converting js to coffeescript...", "Results will be copied to your system buffer");
        },
        error: function(data) {
          return alert('coffescript converting error');
        }
      });
    };

    return Converter;

  })();

  Clipboard = (function() {

    function Clipboard() {
      this.copy = __bind(this.copy, this);
      this.document = document;
      this.from = $('<textarea/>');
      this.body = $('body');
    }

    Clipboard.prototype.copy = function(text) {
      this.from.text(text);
      this.body.append(this.from);
      this.from.select();
      this.document.execCommand('copy');
      return this.from.remove();
    };

    return Clipboard;

  })();

  Notification = (function() {
    var SCRIPT_URL;

    function Notification() {}

    SCRIPT_URL = "build/popup.js";

    Notification.prototype.show = function(type, title, content) {
      localStorage.setItem('converter-message-type', type);
      localStorage.setItem('converter-message-title', title);
      localStorage.setItem('converter-message-content', content);
      return chrome.tabs.executeScript(null, {
        file: SCRIPT_URL
      });
    };

    return Notification;

  })();

  applcation = new Application();

  chrome.extension.onMessage.addListener(function(request, sender, sendResponse) {
    var response;
    if (request.method === "getConverterData") {
      response = {
        type: localStorage.getItem('converter-message-type'),
        title: localStorage.getItem('converter-message-title'),
        content: localStorage.getItem('converter-message-content')
      };
      return sendResponse(response);
    } else if (request.method === "clearConverterData") {
      localStorage.setItem('converter-message-type', null);
      localStorage.setItem('converter-message-title', null);
      localStorage.setItem('converter-message-content', null);
      return sendResponse({});
    } else {
      return sendResponse({});
    }
  });

}).call(this);
