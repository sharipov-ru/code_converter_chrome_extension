// Generated by CoffeeScript 1.3.3
(function() {
  var Application, Clipboard, Converter, Notification, applcation,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Application = (function() {

    function Application() {
      this.setupContextMenus = __bind(this.setupContextMenus, this);
      this.setupContextMenus();
      this.setupMessageListener();
      this.converter = new Converter();
    }

    Application.prototype.setupContextMenus = function() {
      var hamlMenu, sassMenu, scssMenu,
        _this = this;
      hamlMenu = chrome.contextMenus.create({
        title: "Copy as Haml",
        contexts: ["selection"],
        onclick: function(info, tab) {
          return _this.converter.html2haml(info.selectionText);
        }
      });
      sassMenu = chrome.contextMenus.create({
        title: "Copy as SASS",
        contexts: ["selection"],
        onclick: function(info, tab) {
          return _this.converter.css2sass(info.selectionText, "SASS");
        }
      });
      scssMenu = chrome.contextMenus.create({
        title: "Copy as SCSS",
        contexts: ["selection"],
        onclick: function(info, tab) {
          return _this.converter.css2sass(info.selectionText, "SCSS");
        }
      });
      return sassMenu = chrome.contextMenus.create({
        title: "Copy as Coffescript",
        contexts: ["selection"],
        onclick: function(info, tab) {
          return _this.converter.js2coffee(info.selectionText);
        }
      });
    };

    Application.prototype.setupMessageListener = function() {
      return chrome.extension.onMessage.addListener(function(request, sender, sendResponse) {
        var response;
        if (request.method === "getConverterData") {
          response = {
            type: localStorage.getItem('converter-message-type'),
            title: localStorage.getItem('converter-message-title'),
            content: localStorage.getItem('converter-message-content')
          };
          return sendResponse(response);
        } else if (request.method === "clearConverterData") {
          localStorage.setItem('converter-message-type', null);
          localStorage.setItem('converter-message-title', null);
          localStorage.setItem('converter-message-content', null);
          return sendResponse({});
        } else {
          return sendResponse({});
        }
      });
    };

    return Application;

  })();

  Converter = (function() {

    function Converter() {
      this.js2coffee = __bind(this.js2coffee, this);

      this.css2sass = __bind(this.css2sass, this);

      this.html2haml = __bind(this.html2haml, this);
      this.notification = new Notification();
    }

    Converter.prototype.html2haml = function(selectedText) {
      var htmlSample,
        _this = this;
      htmlSample = "{page: {html: '" + selectedText + "'}}";
      this.notification.showInfo("Converting html to haml...");
      return $.ajax({
        url: "http://html2haml.heroku.com/api.json",
        type: "POST",
        data: htmlSample,
        dataType: "json",
        success: function(data) {
          var clipboard;
          clipboard = new Clipboard();
          clipboard.copy(data.page.haml);
          return _this.notification.showSuccess();
        },
        error: function(data) {
          return _this.notification.showError();
        }
      });
    };

    Converter.prototype.css2sass = function(selectedText, sassType) {
      var _this = this;
      this.notification.showInfo("Converting css to " + sassType + "...");
      return $.ajax({
        url: "http://css2sass.heroku.com/json",
        type: "POST",
        data: {
          page: {
            css: selectedText
          },
          commit: "Convert 2" + " " + sassType
        },
        dataType: "json",
        success: function(data) {
          var clipboard;
          clipboard = new Clipboard();
          clipboard.copy(data.page.sass);
          return _this.notification.showSuccess();
        },
        error: function(data) {
          return _this.notification.showError();
        }
      });
    };

    Converter.prototype.js2coffee = function(selectedText) {
      var _this = this;
      this.notification.showInfo("Converting js to coffeescript...");
      return $.ajax({
        url: "http://git.rordev.ru:8080/convert",
        type: "POST",
        data: {
          js: selectedText
        },
        dataType: "json",
        success: function(data) {
          var clipboard;
          clipboard = new Clipboard();
          clipboard.copy(data.coffee);
          return _this.notification.showSuccess();
        },
        error: function(data) {
          return _this.notification.showError();
        }
      });
    };

    return Converter;

  })();

  Clipboard = (function() {

    function Clipboard() {
      this.copy = __bind(this.copy, this);
      this.document = document;
      this.from = $('<textarea/>');
      this.body = $('body');
    }

    Clipboard.prototype.copy = function(text) {
      this.from.text(text);
      this.body.append(this.from);
      this.from.select();
      this.document.execCommand('copy');
      return this.from.remove();
    };

    return Clipboard;

  })();

  Notification = (function() {
    var ERROR_MESSAGE, INFO_MESSAGE, SCRIPT_URL, SUCCESS_MESSAGE;

    function Notification() {}

    SCRIPT_URL = "build/popup.js";

    INFO_MESSAGE = 'Results will be copied to your system buffer';

    ERROR_MESSAGE = 'Please, make sure that snippet syntax is OK';

    SUCCESS_MESSAGE = 'Results copied to your system buffer. Paste it in your favorite editor!';

    Notification.prototype.show = function(type, title, content) {
      localStorage.setItem('converter-message-type', type);
      localStorage.setItem('converter-message-title', title);
      localStorage.setItem('converter-message-content', content);
      return chrome.tabs.executeScript(null, {
        file: SCRIPT_URL
      });
    };

    Notification.prototype.showInfo = function(title) {
      return this.show('info', title, INFO_MESSAGE);
    };

    Notification.prototype.showError = function() {
      return this.show('error', 'API Error', ERROR_MESSAGE);
    };

    Notification.prototype.showSuccess = function() {
      return this.show("success", "Converted!", SUCCESS_MESSAGE);
    };

    return Notification;

  })();

  applcation = new Application();

}).call(this);
